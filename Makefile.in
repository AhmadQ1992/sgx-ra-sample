SGX_ENCLAVES:=@SGX_ENCLAVES@

CC=@CC@
# Define ENCLAVE_LIBDIR to hardcode the library path that enclaves 
# are loaded from. Otherwise, create_enclave will search in the
# programs current working directory.
#CFLAGS=@CFLAGS@ -fno-builtin-memset
CFLAGS=@CFLAGS@ -fno-builtin-memset
CPPFLAGS=@CPPFLAGS@
LDFLAGS=@LDFLAGS@ -L$(SGXSDK_LIBDIR)
LIBS=@LIBS@

INSTALL=@INSTALL@
prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
libdir=@libdir@
enclave_libdir=@enclave_libdir@

APP_OBJS=main.o sgx_stub.o

%.o: %.c
	$(CC) -c $(CPPFLAGS) $(CFLAGS) -I$(SGXSDK_INCDIR) $<

all: enclavereport $(SGX_ENCLAVES)

install: install-program install-enclaves

install-program: all 
	$(INSTALL) -d $(bindir)
	$(INSTALL) -t $(bindir) enclavereport

install-enclaves:
	for dir in $(SGX_ENCLAVES); do \
		$(MAKE) -C $$dir install; \
	done

include sgx_app.mk

enclavereport: $(ENCLAVE_UOBJS) $(APP_OBJS)
	$(CC) -o $@ $(LDFLAGS) $(APP_OBJS) $(ENCLAVE_UOBJS) $(LIBS) -ldl

clean: clean_enclaves
	rm -f enclavereport $(APP_OBJS) $(ENCLAVE_CLEAN)

distclean: clean distclean_enclaves
	rm -rf Makefile config.log config.status config.h autom4te.cache
	rm -rf sgx_app.mk sgx_enclave.mk

