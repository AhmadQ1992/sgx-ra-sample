#! /bin/bash

#----------------------------------------------------------------------------
# Get our program name
#----------------------------------------------------------------------------

PROG=`basename $0`


#----------------------------------------------------------------------------
# Environment setup.
#----------------------------------------------------------------------------

# Where is OpenSSL 1.1.x?

OPENSSL_LIBDIR=@OPENSSL_LIBDIR@
if [ "$OPENSSL_LIBDIR" = "" ]
then
	echo "Could not auto-detect openssl v1.1.0 or newer. Make sure LD_LIBRARY_PATH is set" >&2
else
	if [ "$LD_LIBRARY_PATH" = "" ]
	then
		export LD_LIBRARY_PATH=$OPENSSL_LIBDIR
	else
		export LD_LIBRARY_PATH=$OPENSSL_LIBDIR:$LD_LIBRARY_PATH
	fi
fi

# Do we need to add curl's libdir?

CURL_LIBDIR=@CURL_LIBDIR@
if [ "$CURL_LIBDIR" != "" ]
then
	if [ "$LD_LIBRARY_PATH" = "" ]
	then
		export LD_LIBRARY_PATH=$OPENSSL_LIBDIR
	else
		export LD_LIBRARY_PATH=$OPENSSL_LIBDIR:$LD_LIBRARY_PATH
	fi
fi

#----------------------------------------------------------------------------
# Parse our settings file
#----------------------------------------------------------------------------

source settings

if [ "$IAS_CLIENT_CERT_KEY_PASSWORD_FILE" != "" ]; then
	sp_arg_e="--ias-cert-passwd-file=$IAS_CLIENT_CERT_KEY_PASSWORD_FILE"
fi

if [ "$VERBOSE" != "" -a "$VERBOSE" -ne 0 ]; then
	arg_v=-v
fi

if [ "$DEBUG" != "" -a "$DEBUG" -ne 0 ]; then
	arg_d=-d
fi

if [ "$LINKABLE" != "" -a "$LINKABLE" -ne 0 ]; then
	arg_l=-l
fi

if [ "$QUERY_IAS_PRODUCTION" != "" -a "$QUERY_IAS_PRODUCTION" -ne 0 ]; then
	sp_arg_P=-P
fi

if [ "$RANDOM_NONCE" != "" -a "$RANDOM_NONCE" -ne 0 ]; then
	client_arg_r=-r
fi


#----------------------------------------------------------------------------
# Execute
#----------------------------------------------------------------------------

if [ "$PROG" = "run-client" ]
then
	./client \
		-s $SPID \
		$client_arg_r \
		$arg_v $arg_d \
		"$@"
elif [ "$PROG" = "run-server" ]
then
	./sp \
		-s $SPID "$@" \
		-A "$IAS_REPORT_SIGNING_CA_FILE" \
		-C "$IAS_CLIENT_CERT_FILE" \
		$sp_arg_e $sp_arg_P \
		$arg_v $arg_d \
		"$@"
else
	echo "$PROG: unrecognized instance (expected run-client or run-server)" >&2
	exit 1
fi

